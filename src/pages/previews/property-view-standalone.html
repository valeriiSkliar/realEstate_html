<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Недвижимость</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <app-header></app-header>
    <app-mobile-menu></app-mobile-menu>

    <main class="page-content">
      <div id="app">
        <div class="property-detail-page">
          <div class="featured-section">
            <custom-breadcrumb theme="light" class="my-3">
              <breadcrumb-item href="/">Главная</breadcrumb-item>
              <breadcrumb-item href="/search.html">Поиск</breadcrumb-item>
              <breadcrumb-item href="/property-view-standalone.html"
                >Студия, 65.6 м² | Черемушки</breadcrumb-item
              >
            </custom-breadcrumb>
          </div>
          <div class="container-fluid px-0">
            <div class="property-gallery mb-4">
              <div class="gallery-container">
                <div class="gallery-thumbnails">
                  <div class="thumbnail-item active" data-index="0">
                    <img
                      src="https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_1"
                      alt="Preview 1"
                    />
                  </div>
                  <div class="thumbnail-item" data-index="1">
                    <img
                      src="https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_2"
                      alt="Preview 2"
                    />
                  </div>
                  <div class="thumbnail-item" data-index="2">
                    <img
                      src="https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_3"
                      alt="Preview 3"
                    />
                  </div>
                  <div class="thumbnail-item" data-index="3">
                    <img
                      src="https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_4"
                      alt="Preview 4"
                    />
                  </div>
                  <div class="thumbnail-item" data-index="4">
                    <img
                      src="https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_5"
                      alt="Preview 5"
                    />
                  </div>
                </div>

                <div class="gallery-main">
                  <div class="main-image-container">
                    <button
                      class="gallery-nav-btn gallery-nav-prev"
                      id="gallery-prev"
                    >
                      <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="main-image-wrapper">
                      <img
                        id="main-gallery-image"
                        src="https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_1"
                        class="main-image"
                        alt="3-комнатная квартира, 85 м²"
                        style="cursor: pointer"
                      />
                    </div>
                    <button
                      class="gallery-nav-btn gallery-nav-next"
                      id="gallery-next"
                    >
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="container-fluid px-0">
            <div class="property-detail-header">
              <h1 class="property-detail-header__title">
                Студия, 65.6 м² | Черемушки
              </h1>
              <button
                class="property-detail-header__favorite-btn"
                type="button"
                aria-label="Добавить в избранное"
              >
                <i class="bi bi-heart"></i>
              </button>
            </div>
          </div>
          <div class="property-detail-pricing">
            <div class="property-detail-pricing__main">
              <div class="price-block">
                <div class="price-block__main">₽ 12 000 000</div>
                <div class="price-block__per-meter">127 000 ₽ за м²</div>
              </div>
              <div class="author-block">
                <div class="author-block__label">Автор</div>
                <a href="tel:89182542536" class="author-block__phone"
                  >8 918 254 25 36</a
                >
              </div>
            </div>
          </div>

          <div class="property-detail-info">
            <div class="property-detail-info__main">
              <div class="property-info-block">
                <h2 class="property-info-block__complex-name">
                  ЖК «Солнечный»
                </h2>
                <div class="property-info-block__address">
                  Краснодар, ул. Ленина, 126, Фестивальный
                </div>
              </div>
              <div class="property-meta-block">
                <div class="property-meta-block__item">
                  <span class="property-meta-block__label">Обновлено:</span>
                  <span class="property-meta-block__value"
                    >сегодня в 10:45</span
                  >
                </div>
                <div class="property-meta-block__item">
                  <span class="property-meta-block__stats"
                    >1198 просмотров, 41 за сегодня</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="property-characteristics">
            <div class="property-characteristics__main">
              <h3 class="property-characteristics__title">О квартире</h3>
              <div class="property-characteristics__grid">
                <div class="characteristic-item">
                  <span class="characteristic-item__label"
                    >Название комплекса</span
                  >
                  <span class="characteristic-item__value">ЖК «Фонтаны»</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label">Район</span>
                  <span class="characteristic-item__value">Черемушки мкр.</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label">Улица</span>
                  <span class="characteristic-item__value"
                    >Ставропольская ул.</span
                  >
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label"
                    >Количество комнат</span
                  >
                  <span class="characteristic-item__value">Студия</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label"
                    >Общая площадь, м²</span
                  >
                  <span class="characteristic-item__value">65.60</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label">Состояние</span>
                  <span class="characteristic-item__value">Ремонт</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label">Этаж</span>
                  <span class="characteristic-item__value">10</span>
                </div>
                <div class="characteristic-item">
                  <span class="characteristic-item__label">Телефон агента</span>
                  <a href="tel:89182542536" class="characteristic-item__value"
                    >8 918 254 25 36</a
                  >
                </div>
              </div>
              <h3 class="property-characteristics__description-title">
                Описание
              </h3>
              <div
                class="property-characteristics__description"
                id="property-description"
              >
                <div class="description-full-text" style="display: none">
                  <p>
                    Продается прекрасная студия в современном жилом комплексе
                    "Фонтаны" в микрорайоне Черемушки. Квартира расположена на
                    10 этаже нового дома с современной планировкой и
                    качественной отделкой. Общая площадь составляет 65,6
                    квадратных метров, что идеально подходит для комфортного
                    проживания одного человека или молодой пары. Квартира
                    полностью готова к проживанию - выполнен качественный ремонт
                    с использованием современных материалов. Установлены
                    пластиковые окна, натяжные потолки, ламинат и керамическая
                    плитка. Кухня оборудована встроенной техникой и мебелью.
                    Санузел совмещенный с современной сантехникой и душевой
                    кабиной. Жилой комплекс располагает развитой
                    инфраструктурой: детская площадка, парковка, консьерж,
                    видеонаблюдение. В шаговой доступности находятся магазины,
                    школы, детские сады, медицинские учреждения и остановки
                    общественного транспорта. Отличное транспортное сообщение с
                    центром города.
                  </p>
                </div>
                <div class="description-preview"></div>
              </div>
              <div
                class="property-characteristics__description-more"
                id="description-toggle"
              >
                <button
                  type="button"
                  class="property-characteristics__description-more-link"
                  id="description-toggle-btn"
                >
                  <span class="toggle-text">Читать далее</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
              </div>
            </div>
          </div>
          <div
            class="container-fluid px-0 mt-3 d-flex flex-column justify-content-center align-items-center gap-3"
          >
            <brand-button variant="solid">Добавить в подборку</brand-button>
            <brand-button variant="solid" color="turquoise"
              >Пожаловаться</brand-button
            >
          </div>
        </div>
      </div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" aria-hidden="true">
      <div class="image-modal__overlay">
        <div class="image-modal__container">
          <button class="image-modal__close" type="button" aria-label="Закрыть">
            <i class="bi bi-x"></i>
          </button>

          <div class="image-modal__content">
            <button
              class="image-modal__nav image-modal__nav--prev"
              type="button"
              aria-label="Предыдущее изображение"
            >
              <i class="bi bi-chevron-left"></i>
            </button>

            <div class="image-modal__image-container">
              <img id="modalImage" src="" alt="" class="image-modal__image" />
            </div>

            <button
              class="image-modal__nav image-modal__nav--next"
              type="button"
              aria-label="Следующее изображение"
            >
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>

          <div class="image-modal__counter">
            <span id="modalCounter">1 / 5</span>
          </div>
        </div>
      </div>
    </div>

    <app-footer></app-footer>
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Gallery images data
        const galleryImages = [
          {
            src: "https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_1",
            thumb:
              "https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_1",
            alt: "Изображение 1",
          },
          {
            src: "https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_2",
            thumb:
              "https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_2",
            alt: "Изображение 2",
          },
          {
            src: "https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_3",
            thumb:
              "https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_3",
            alt: "Изображение 3",
          },
          {
            src: "https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_4",
            thumb:
              "https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_4",
            alt: "Изображение 4",
          },
          {
            src: "https://fakeimg.pl/1920x1080/?retina=1&font=noto&text=image_5",
            thumb:
              "https://fakeimg.pl/200x150/?retina=1&font=noto&text=image_5",
            alt: "Изображение 5",
          },
        ];

        let currentImageIndex = 0;
        const mainImage = document.getElementById("main-gallery-image");
        const thumbnails = document.querySelectorAll(".thumbnail-item");
        const prevBtn = document.getElementById("gallery-prev");
        const nextBtn = document.getElementById("gallery-next");

        // Modal elements
        const imageModal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");
        const modalCounter = document.getElementById("modalCounter");
        const modalCloseBtn = imageModal.querySelector(".image-modal__close");
        const modalOverlay = imageModal.querySelector(".image-modal__overlay");
        const modalPrevBtn = imageModal.querySelector(
          ".image-modal__nav--prev"
        );
        const modalNextBtn = imageModal.querySelector(
          ".image-modal__nav--next"
        );

        // Function to update main image
        function updateMainImage(index) {
          if (index < 0 || index >= galleryImages.length) return;

          currentImageIndex = index;
          mainImage.src = galleryImages[index].src;
          mainImage.alt = galleryImages[index].alt;

          // Update active thumbnail
          thumbnails.forEach((thumb, i) => {
            thumb.classList.toggle("active", i === index);
          });
        }

        // Modal functions
        function openModal(index) {
          if (index < 0 || index >= galleryImages.length) return;

          currentImageIndex = index;
          modalImage.src = galleryImages[index].src;
          modalImage.alt = galleryImages[index].alt;
          modalCounter.textContent = `${index + 1} / ${galleryImages.length}`;

          imageModal.classList.add("active");
          imageModal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden"; // Prevent body scroll
        }

        function closeModal() {
          imageModal.classList.remove("active");
          imageModal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = ""; // Restore body scroll
        }

        function updateModalImage(index) {
          if (index < 0 || index >= galleryImages.length) return;

          currentImageIndex = index;
          modalImage.src = galleryImages[index].src;
          modalImage.alt = galleryImages[index].alt;
          modalCounter.textContent = `${index + 1} / ${galleryImages.length}`;

          // Also update the main gallery
          updateMainImage(index);
        }

        // Main image click to open modal
        mainImage.addEventListener("click", () => {
          openModal(currentImageIndex);
        });

        // Modal navigation
        modalPrevBtn.addEventListener("click", () => {
          const newIndex =
            currentImageIndex > 0
              ? currentImageIndex - 1
              : galleryImages.length - 1;
          updateModalImage(newIndex);
        });

        modalNextBtn.addEventListener("click", () => {
          const newIndex =
            currentImageIndex < galleryImages.length - 1
              ? currentImageIndex + 1
              : 0;
          updateModalImage(newIndex);
        });

        // Modal close handlers
        modalCloseBtn.addEventListener("click", closeModal);

        // Improved modal overlay click handler
        imageModal.addEventListener("click", (e) => {
          // Close modal if clicked outside the image container
          if (
            !e.target.closest(".image-modal__container") ||
            e.target.classList.contains("image-modal__overlay")
          ) {
            console.log("closeModal");
            closeModal();
          }
        });

        // Prevent modal from closing when clicking on modal content
        const modalContainer = imageModal.querySelector(
          ".image-modal__container"
        );
        modalContainer.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        // Thumbnail click handlers
        thumbnails.forEach((thumbnail, index) => {
          thumbnail.addEventListener("click", () => {
            updateMainImage(index);
          });
        });

        // Navigation buttons
        prevBtn.addEventListener("click", () => {
          const newIndex =
            currentImageIndex > 0
              ? currentImageIndex - 1
              : galleryImages.length - 1;
          updateMainImage(newIndex);
        });

        nextBtn.addEventListener("click", () => {
          const newIndex =
            currentImageIndex < galleryImages.length - 1
              ? currentImageIndex + 1
              : 0;
          updateMainImage(newIndex);
        });

        // Keyboard navigation
        document.addEventListener("keydown", (e) => {
          if (imageModal.classList.contains("active")) {
            // Modal is open
            if (e.key === "Escape") {
              closeModal();
            } else if (e.key === "ArrowLeft") {
              modalPrevBtn.click();
            } else if (e.key === "ArrowRight") {
              modalNextBtn.click();
            }
          } else {
            // Modal is closed, normal gallery navigation
            if (e.key === "ArrowLeft") {
              prevBtn.click();
            } else if (e.key === "ArrowRight") {
              nextBtn.click();
            }
          }
        });

        // Touch/Swipe navigation
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        const minSwipeDistance = 50; // Минимальная дистанция для срабатывания свайпа
        const maxVerticalDistance = 100; // Максимальное вертикальное смещение для горизонтального свайпа

        const mainImageWrapper = document.querySelector(".main-image-wrapper");

        if (mainImageWrapper) {
          // Начало касания
          mainImageWrapper.addEventListener(
            "touchstart",
            (e) => {
              touchStartX = e.touches[0].clientX;
              touchStartY = e.touches[0].clientY;
            },
            { passive: true }
          );

          // Конец касания
          mainImageWrapper.addEventListener(
            "touchend",
            (e) => {
              touchEndX = e.changedTouches[0].clientX;
              touchEndY = e.changedTouches[0].clientY;
              handleSwipe();
            },
            { passive: true }
          );
        }

        // Функция обработки свайпа
        function handleSwipe() {
          const deltaX = touchEndX - touchStartX;
          const deltaY = Math.abs(touchEndY - touchStartY);

          // Проверяем, что это горизонтальный свайп достаточной длины
          if (
            Math.abs(deltaX) > minSwipeDistance &&
            deltaY < maxVerticalDistance
          ) {
            if (deltaX > 0) {
              // Свайп вправо - предыдущее изображение
              prevBtn.click();
            } else {
              // Свайп влево - следующее изображение
              nextBtn.click();
            }
          }
        }

        // Modal touch events for mobile
        let modalTouchStartX = 0;
        let modalTouchStartY = 0;
        let modalTouchEndX = 0;
        let modalTouchEndY = 0;

        // Touch events for modal overlay to close on tap outside
        imageModal.addEventListener(
          "touchstart",
          (e) => {
            modalTouchStartX = e.touches[0].clientX;
            modalTouchStartY = e.touches[0].clientY;
          },
          { passive: true }
        );

        imageModal.addEventListener(
          "touchend",
          (e) => {
            modalTouchEndX = e.changedTouches[0].clientX;
            modalTouchEndY = e.changedTouches[0].clientY;

            // Check if it's a tap (not a swipe)
            const deltaX = Math.abs(modalTouchEndX - modalTouchStartX);
            const deltaY = Math.abs(modalTouchEndY - modalTouchStartY);
            const isTap = deltaX < 10 && deltaY < 10; // Small threshold for tap detection

            if (isTap && !e.target.closest(".image-modal__container")) {
              closeModal();
            }
          },
          { passive: true }
        );

        // Favorite button toggle
        const favoriteButton = document.querySelector(
          ".property-detail-header__favorite-btn"
        );
        if (favoriteButton) {
          favoriteButton.addEventListener("click", function () {
            const icon = this.querySelector("i");
            icon.classList.toggle("bi-heart");
            icon.classList.toggle("bi-heart-fill");
            // Дополнительно можно менять title
            if (icon.classList.contains("bi-heart-fill")) {
              this.title = "Удалить из избранного";
              this.setAttribute("aria-label", "Удалить из избранного");
            } else {
              this.title = "Добавить в избранное";
              this.setAttribute("aria-label", "Добавить в избранное");
            }
          });
        }

        // Description read more functionality
        function initDescriptionToggle() {
          const descriptionContainer = document.getElementById(
            "property-description"
          );
          const fullTextContainer = descriptionContainer.querySelector(
            ".description-full-text"
          );
          const previewContainer = descriptionContainer.querySelector(
            ".description-preview"
          );
          const toggleContainer = document.getElementById("description-toggle");
          const toggleBtn = document.getElementById("description-toggle-btn");
          const toggleText = toggleBtn.querySelector(".toggle-text");

          if (!fullTextContainer || !previewContainer || !toggleBtn) return;

          // Получаем полный текст
          const fullText = fullTextContainer.textContent.trim();
          const maxLength = 250; // Максимальная длина для превью
          let isExpanded = false;

          // Если текст короткий, скрываем кнопку
          if (fullText.length <= maxLength) {
            previewContainer.innerHTML = fullTextContainer.innerHTML;
            toggleContainer.classList.add(
              "property-characteristics__description-more--hidden"
            );
            return;
          }

          // Создаем обрезанный текст для превью
          function createPreviewText() {
            const truncatedText = fullText.substring(0, maxLength);
            const lastSpaceIndex = truncatedText.lastIndexOf(" ");
            const previewText =
              truncatedText.substring(0, lastSpaceIndex) + "...";

            // Сохраняем HTML структуру
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = fullTextContainer.innerHTML;
            const textContent = tempDiv.textContent || tempDiv.innerText;

            if (textContent.length > maxLength) {
              // Находим позицию обрезки в HTML
              let charCount = 0;
              let truncatedHTML = "";
              const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_TEXT,
                null,
                false
              );

              let node;
              while ((node = walker.nextNode())) {
                const nodeText = node.textContent;
                if (charCount + nodeText.length > lastSpaceIndex) {
                  const remainingChars = lastSpaceIndex - charCount;
                  if (remainingChars > 0) {
                    node.textContent =
                      nodeText.substring(0, remainingChars) + "...";
                  } else {
                    node.textContent = "";
                  }
                  break;
                }
                charCount += nodeText.length;
              }

              previewContainer.innerHTML = tempDiv.innerHTML;
            } else {
              previewContainer.innerHTML = fullTextContainer.innerHTML;
            }
          }

          // Инициализация
          createPreviewText();

          // Обработчик клика по кнопке
          toggleBtn.addEventListener("click", function () {
            isExpanded = !isExpanded;

            if (isExpanded) {
              // Показываем полный текст
              previewContainer.style.display = "none";
              fullTextContainer.style.display = "block";
              toggleText.textContent = "Скрыть";
              toggleBtn.classList.add("expanded");
            } else {
              // Показываем превью
              fullTextContainer.style.display = "none";
              previewContainer.style.display = "block";
              toggleText.textContent = "Читать далее";
              toggleBtn.classList.remove("expanded");
            }
          });
        }

        // Инициализируем функциональность описания
        initDescriptionToggle();
      });
    </script>
  </body>
</html>
